version: "3.6"

services:
  mariadb:
    image: mariadb
    container_name: mariadb
# MARIADB_USER=www-data
    user: ${MARIADB_USER}
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
# MOUNTED_DATA_DIR=/mnt
      - ${MOUNTED_DATA_DIR}/mysql:/var/lib/mysql
      - /etc/localtime:/etc/localtime:ro
    environment:
      - GOSU_VERSION=1.14
      - MARIADB_MYSQL_LOCALHOST_USER=true
# MYSQL_ROOT_PASSWORD=***PASSWORD***
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - TZ=${TZ}
# PUID=33
      - PUID=${PUID}
# PGID=33
      - PGID=${PGID}
#      - MYSQL_DATABASE=${MYSQL_DATABASE}
#      - MYSQL_USER=${MYSQL_USER}
#      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
#      - MYSQL_HOST=${MYSQL_DATABASE}:3306
#      - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mysql nextcloud -uroot -p${MYSQL_ROOT_PASSWORD} -e 'SELECT 1;'  || exit 1"]
      interval: 2s
      retries: 120
    networks:
      - proxy
    ports:
      - "32768:3306"
    labels:
      - "traefik.docker.network=proxy"
      - "traefik.enable=true"

  nextcloud:
    image: nextcloud
    container_name: nextcloud
    depends_on:
      mariadb:
        condition: service_healthy
    volumes:
# MOUNTED_DATA_DIR=/mnt
      - ${MOUNTED_DATA_DIR}/nextcloud:/var/www/html
    restart: unless-stopped
    environment:
# PUID=33
      - PUID=${PUID}
# PGID=33
      - PGID=${PGID}
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.entrypoints=http"
# DOMAINNAME=subdomain.mydomain.com
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.${DOMAINNAME}`)"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.nextcloud.middlewares=https-redirect"
      - "traefik.http.routers.nextcloud-secure.entrypoints=https"
# DOMAINNAME=subdomain.mydomain.com
      - "traefik.http.routers.nextcloud-secure.rule=Host(`nextcloud.${DOMAINNAME}`)"
      - "traefik.http.middlewares.nextcloud_redirectregex.redirectregex.regex=https://(.*)/.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud_redirectregex.redirectregex.replacement=https://$$1/remote.php/dav/"
      - "traefik.http.middlewares.nextcloud_redirectregex.redirectregex.permanent=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.nextcloud-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.customRequestHeaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.nextcloud-secure.middlewares=nextcloud_redirectregex,nextcloud-headers"
      - "traefik.http.routers.nextcloud-secure.tls=true"
      - "traefik.http.routers.nextcloud-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.nextcloud-secure.service=nextcloud"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"

  nextcloud-cronjob:
    image: rcdailey/nextcloud-cronjob
    container_name: nextcloud-cronjob
    depends_on:
      - nextcloud
    volumes:
# MOUNTED_DATA_DIR=/mnt
      - ${MOUNTED_DATA_DIR}/nextcloud:/var/www/html
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    environment:
      - NEXTCLOUD_CONTAINER_NAME=nextcloud
      - NEXTCLOUD_CRON_MINUTE_INTERVAL=5
      - NEXTCLOUD_EXEC_SHELL=bash
      - NEXTCLOUD_EXEC_SHELL_ARGS=-c
# NEXTCLOUD_USER=www-data
      - NEXTCLOUD_EXEC_USER=${NEXTCLOUD_USER}
#      - NEXTCLOUD_PROJECT_NAME
      - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    networks:
      - proxy

networks:
  proxy:
    name: proxy
    external: true
